<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Monopoly Player Selection</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    background: black;
    font-family: sans-serif;
    display: flex;
    overflow: hidden;
    color: white;
  }

  /* Left: Monopoly Board */
  #boardWrapper {
    width: 50%;
    height: 100%;
    background: black;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  #board {
    position: relative;
    width: 900px;
    max-width: 900px;
    aspect-ratio: 1 / 1;
  }

  #boardImg {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .piece {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    border: 3px solid transparent;
    box-shadow: 0 0 6px rgba(0,0,0,0.4);
    transition: left 0.4s ease, top 0.4s ease;
    color: white;
  }
  .red { background: #ff4d4d; border-color: #ff8080; }
  .blue { background: #3399ff; border-color: #66a3ff; }
  .yellow { background: goldenrod; border-color: #ffde59; color: black; }
  .green { background: limegreen; border-color: #aaffaa; color: black; }

  /* Central container for money + displays */
  #centralDisplayContainer {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }

  /* Money container */
  #moneyContainer {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 220px;
  }
  .moneyBox {
    padding: 12px 20px;
    border-radius: 10px;
    width: 100%;
    text-align: center;
    font-weight: bold;
    font-size: 22px;
    word-wrap: break-word;
    box-shadow: 0 0 12px #6a0dad,0 0 18px #00d4ff;
    color: white;
  }
  .moneyBox.red { background: #ff4d4d; }
  .moneyBox.blue { background: #3399ff; }
  .moneyBox.yellow { background: goldenrod; color: black; }
  .moneyBox.green { background: limegreen; color: black; }

  /* Display boxes */
  #displayContainer {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
  }
  .displayBox {
    padding: 15px 20px;
    border-radius: 12px;
    width: 300px;
    text-align: center;
    font-weight: bold;
    font-size: 22px;
    background: linear-gradient(135deg,#6a0dad,#00d4ff);
    color: white;
    box-shadow: 0 0 12px #6a0dad,0 0 18px #00d4ff;
    word-wrap: break-word;
  }

  /* Quick links */
  #propertyLink, #rulesLink {
    position: absolute;
    z-index: 20;
  }
  #propertyLink img, #rulesLink img {
    width: 75px;
    border-radius: 8px;
    box-shadow: 0 0 6px rgba(255,255,255,0.5);
  }
  #propertyLink { top: 40%; left: 235px; transform: translateY(-50%); }
  #rulesLink { top: 50%; right: 580px; transform: translateY(-50%); }

  /* Buildings */
  .hotel, .house {
    width: 29px;
    height: 29px;
    position: absolute;
  }
  
#playerContainer {
  width: 50%;
  height: 100%;
  background: #111;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  box-shadow: inset 0 0 40px rgba(0, 212, 255, 0.3);
}


.playerSection {
  background: rgba(0,0,0,0.5);
  padding: 25px 30px;
  border-radius: 16px;
  margin-bottom: 40px;
  width: 300px;
  text-align: center;
  box-shadow: 0 0 15px #6a0dad, 0 0 25px #00d4ff;
}

.playerSection h2 {
  color: #FFD700;
  margin-bottom: 20px;
  text-shadow: 0 0 8px black;
}

/* Buttons */
.playerBtn {
  background: linear-gradient(135deg, #6a0dad, #00d4ff);
  color: white;
  border: none;
  padding: 12px 30px;
  margin: 8px;
  font-size: 18px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 0 0 12px #00d4ff, 0 0 16px #6a0dad;
  transition: 0.2s ease;
}

.playerBtn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px #00d4ff, 0 0 30px #6a0dad;
}

.playerBtn:active {
  transform: scale(0.97);
}



</style>
</head>
<body>

<!-- Left: Monopoly Board -->
<div id="boardWrapper">
  <div id="board">
    <img id="boardImg" src="map2.jpg" alt="Monopoly Board">
    <div id="p1" class="piece red">p1</div>
    <div id="p2" class="piece blue">p2</div>
    <div id="p3" class="piece yellow">p3</div>
    <div id="p4" class="piece green">p4</div>

    <div id="centralDisplayContainer">
      <div id="moneyContainer">
        <div id="money-p1-overlay" class="moneyBox red">Player1: $0</div>
        <div id="money-p2-overlay" class="moneyBox blue">Player2: $0</div>
        <div id="money-p3-overlay" class="moneyBox yellow">Player3: $0</div>
        <div id="money-p4-overlay" class="moneyBox green">Player4: $0</div>
      </div>
      <div id="displayContainer">
        <div id="display1" class="displayBox">Display 1</div>
        <div id="display2" class="displayBox">Display 2</div>
      </div>
    </div>

    <div id="propertyLink">
      <a href="https://raw.githubusercontent.com/nightywolfy/monopoly/main/properties.jpg" target="_blank">
        <img src="https://raw.githubusercontent.com/nightywolfy/monopoly/main/properties.jpg">
      </a>
    </div>
    <div id="rulesLink">
      <a href="https://raw.githubusercontent.com/nightywolfy/monopoly/main/rules.jpg" target="_blank">
        <img src="https://raw.githubusercontent.com/nightywolfy/monopoly/main/rules.jpg">
      </a>
    </div>
  </div>
</div>

<!-- Right side: Player selection -->
<div id="playerContainer">

  <div class="playerSection">
    <h2>2-Player Game</h2>
    <button class="playerBtn" onclick="choosePlayer('player1','2p')">Player 1</button>
    <button class="playerBtn" onclick="choosePlayer('player2','2p')">Player 2</button>
  </div>

 <div class="playerSection">
  <h2>3-4 Player Game</h2>
  <button class="playerBtn" onclick="choosePlayer('p1','4p')">Player 1</button>
  <button class="playerBtn" onclick="choosePlayer('p2','4p')">Player 2</button>
  <button class="playerBtn" onclick="choosePlayer('p3','4p')">Player 3</button>
  <button class="playerBtn" onclick="choosePlayer('p4','4p')">Player 4</button>
</div>

</div>


<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const colorMap = {red:"p1", blue:"p2", yellow:"p3", green:"p4"};

const buildingPositions = {
  1: { x: 740, y: 789 },
  3: { x: 595, y: 789 },
  6: { x: 373, y: 789 },
  8: { x: 232, y: 789 },
  9: { x: 160, y: 789 },
  11: { x: 105, y: 735 },
  12: { x: 105, y: 665 },
  14: { x: 105, y: 515 },
  16: { x: 105, y: 375 },
  17: { x: 105, y: 300 },
  19: { x: 105, y: 155 },
  21: { x: 156, y: 107 },
  22: { x: 230, y: 107 },
  24: { x: 375, y: 107 },
  26: { x: 520, y: 107 },
  28: { x: 665, y: 107 },
  29: { x: 740, y: 107 },
  31: { x: 790, y: 155 },
  33: { x: 790, y: 300 },
  34: { x: 790, y: 370 },
  37: { x: 790, y: 590 },
  39: { x: 790, y: 730 },
  0: { x: 595, y: 676 },
  10: { x: 675, y: 590 },
  20: { x: 305, y: 676 },
  30: { x: 221, y: 590 },
  5: { x: 220, y: 305 },
  15: { x: 304, y: 223 },
  25: { x: 595, y: 223 },
  35: { x: 676, y: 305 }
};

// Robust function to render pieces
function updatePieces(data){
    if(!data || typeof data !== 'object'){
        console.warn("Pieces data invalid:", data);
        return;
    }

    for(const [color, pos] of Object.entries(data)){
        const id = colorMap[color];
        if(!id){ console.warn("Unknown color:", color); continue; }
        const el = document.getElementById(id);
        if(!el){ console.warn("Missing element:", id); continue; }
        if(!pos || typeof pos.x !== "number" || typeof pos.y !== "number"){
            console.warn("Invalid position for", color, pos);
            continue;
        }
        el.style.left = pos.x + 'px';
        el.style.top  = pos.y + 'px';
        el.style.zIndex = 20; // above board image
    }
}

// Displays
function updateDisplay1(text){ document.getElementById('display1').innerText = text || ''; }
function updateDisplay2(text){ document.getElementById('display2').innerText = text || ''; }

function updateMoney(data){
  document.getElementById('money-p1-overlay').textContent = 'Player1: $' + data.p1;
  document.getElementById('money-p2-overlay').textContent = 'Player2: $' + data.p2;
  document.getElementById('money-p3-overlay').textContent = 'Player3: $' + data.p3;
  document.getElementById('money-p4-overlay').textContent = 'Player4: $' + data.p4;
}

function renderElements(type, data, imgSrc){
    const board = document.getElementById('board');
    if(!board){ console.error("Board container missing"); return; }

    // Remove existing elements
    document.querySelectorAll(`.${type}`).forEach(el => el.remove());

    if(!data || typeof data !== 'object'){
        console.warn(type + " data invalid:", data);
        return;
    }

    for(const [space, count] of Object.entries(data)){
        if(!count) continue;
        const pos = buildingPositions[space];
        if(!pos){ console.warn("No position for space:", space); continue; }

        // Stack houses horizontally, hotels centered
        for(let i=0;i<count;i++){
            const el = document.createElement('img');
            el.src = imgSrc;
            el.className = type;
            el.style.position = 'absolute';
            el.style.zIndex = 25;

            // Offset each house horizontally
            if(type === 'house'){
                el.style.left = (pos.x - 14 + i*10) + 'px'; // 10px spacing between houses
                el.style.top  = (pos.y - 14) + 'px';
            } else if(type === 'hotel'){
                // hotel always centered, slightly higher if multiple hotels (rare)
                el.style.left = (pos.x - 14) + 'px';
                el.style.top  = (pos.y - 14 - i*2) + 'px';
            }

            el.style.width = '29px';
            el.style.height = '29px';
            board.appendChild(el);

            // Fallback if image fails to load
            el.onerror = () => {
                console.warn("Failed to load image:", imgSrc);
                el.src = 'https://via.placeholder.com/29?text=?';
            }
        }
    }
}

// Initial fetch
fetch('/pieces.json').then(res=>res.json()).then(updatePieces);
fetch('/display1.json').then(res=>res.json()).then(data=>updateDisplay1(data.text));
fetch('/display2.json').then(res=>res.json()).then(data=>updateDisplay2(data.text));
fetch('/money.json').then(res=>res.json()).then(updateMoney);
fetch('/hotels.json').then(res=>res.json()).then(data=>renderElements('hotel',data,'https://raw.githubusercontent.com/nightywolfy/monopoly/main/hotel.webp'));
fetch('/houses.json').then(res=>res.json()).then(data=>renderElements('house',data,'https://raw.githubusercontent.com/nightywolfy/monopoly/main/house.webp'));

// Socket.IO updates
socket.on('piecesUpdate',updatePieces);
socket.on('displayUpdate1', data => updateDisplay1(data.text));
socket.on('displayUpdate2', data => updateDisplay2(data.text));
socket.on('moneyUpdate',updateMoney);
socket.on('hotelsUpdate',data=>renderElements('hotel',data,'https://raw.githubusercontent.com/nightywolfy/monopoly/main/hotel.webp'));
socket.on('housesUpdate',data=>renderElements('house',data,'https://raw.githubusercontent.com/nightywolfy/monopoly/main/house.webp'));

async function choosePlayer(player, gameMode){
  const res = await fetch(`/getKey?player=${player}&game=${gameMode}`);
  const data = await res.json();
  if(data.ok){
    window.location.href = `/player?name=${player}&auth=${data.key}`;
  } else {
    alert('Error getting access key');
  }
}

</script>
</body>
</html>
