<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Monopoly Player Selection</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    background: black;
    font-family: sans-serif;
    display: flex;
    overflow: hidden;
    color: white;
  }

/* Left: Board */
#boardContainer {
  width: 50%;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: relative;
  background: black;
}

/* Board inner */
#board {
  position: relative;
  height: 900px;
  width: 900px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
#boardImg {
  width: 900px;
  height: 900px;

}

/* Pieces */
.piece {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  position: absolute;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  border: 3px solid transparent;
  box-shadow: 0 0 6px rgba(0,0,0,0.4);
  transition: left 0.4s ease, top 0.4s ease;
  color: white;
}
.red { background:#ff4d4d; border-color:#ff8080; }
.blue { background:#3399ff; border-color:#66a3ff; }
.yellow { background:goldenrod; border-color:#ffde59; color:black; }
.green { background:limegreen; border-color:#aaffaa; color:black; }

/* Central container for money + display */
#centralDisplayContainer {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 25px;
  z-index: 10;
}

#moneyContainer {
  display: flex;
  flex-direction: column;
  gap: 20px;       /* slightly bigger gap */
  width: 175px;    /* wider than before */
}

.moneyBox {
  padding: 10px 20px;   /* bigger padding */
  border-radius: 12px;
  width: 100%;          /* fills container */
  text-align: center;
  font-weight: bold;
  font-size: 20px;      /* larger font */
  word-wrap: break-word;
  box-shadow: 0 0 18px #6a0dad, 0 0 24px #00d4ff;
  color: white;
}
.moneyBox.red { background:#ff4d4d; }
.moneyBox.blue { background:#3399ff; }
.moneyBox.yellow { background:goldenrod; color:black; }
.moneyBox.green { background:limegreen; color:black; }

/* Display boxes */
#displayContainer{
  display:flex;
  flex-direction:column;
  gap:15px;
  align-items:center;
}
.displayBox{
  padding:8px 14px;
  border-radius:12px;
  width:300px;
  text-align:center;
  font-weight:bold;
  font-size:22px;
  background:linear-gradient(135deg,#6a0dad,#00d4ff);
  color:white;
  box-shadow:0 0 12px #6a0dad,0 0 18px #00d4ff;
  word-wrap:break-word;
}

/* Quick links with absolute positioning */
#propertyLink, #rulesLink{
  position:absolute;
  z-index:20;
}
#propertyLink img, #rulesLink img{
  width:75px;
  border-radius:8px;
  box-shadow:0 0 6px rgba(255,255,255,0.5);
}

/* Example positions: */
#propertyLink{ top:40%; left:265px; transform:translateY(-50%); }
#rulesLink{ top:50%; right:560px; transform:translateY(-50%); }

/* Buildings */
.hotel,.house{
  width:29px;
  height:29px;
  position:absolute;
}

/* Redeem/Mortgage buttons */
.mode-btn {
  padding: 6px 12px;
  font-size: 0.9em;
  border-radius: 5px;
  border: 1px solid #555;
  background: #111;
  color: #eee;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s ease;
}
.mode-btn.active {
  background: #0077ff;
  color: #fff;
  border-color: #00aaff;
}
.mode-btn:hover {
  background: #333;
}

#modeToggle {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 2px;
  margin-top: -7px; /* closer to map.webp */
  z-index: 60;
  position: relative;
}

/* Top buttons */
#topButtons button {
  padding: 8px 10px;
  font-size: 1em;
  font-weight: bold;
  cursor: pointer;
  border: none;
  border-radius: 8px;
  color: #fff;
  background: linear-gradient(45deg, #0f4f36, #ff416c);
  box-shadow: 0 4px 8px rgba(0,0,0,0.4);
  transition: all 0.2s ease;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
#topButtons button:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 6px 10px rgba(0,0,0,0.5);
}
#topButtons button:active {
  transform: translateY(1px) scale(0.98);
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
}

/* Small buttons */
.small-button {
  padding: 2px 4px;
  font-size: 0.9em;
  border-radius: 6px;
  background: #222;
  color: white;
  cursor: pointer;
}

/* Right: Controls */
#controlsContainer {
  width: 45%;
  height: 100%;
  background: #111;
  display: flex;
  flex-direction: column;
}

/* Inner container for buttons + chat */
#controlsInner {
  display: flex;
  flex-direction: column;
  height: 100%;
  padding: 10px;
  box-sizing: border-box;
}

/* Chat iframe fills remaining space */
#chatFrame {
  flex-grow: 1;
  width: 100%;
  border: none;
  min-height: 0;
}

/* + buttons green */
.white-btn.plus {
  background-color: #28a745 !important;  /* green */
  border: 1px solid #1e7e34 !important;
  color: white !important;
  padding: .1px .1px;
  border-radius: 3px;
  font-weight: bold;
  cursor: pointer;
}

/* - buttons red */
.white-btn.minus {
  background-color: #dc3545 !important;  /* red */
  border: 1px solid #b02a37 !important;
  color: white !important;
  padding: .1px .1px;
  border-radius: 3px;
  font-weight: bold;
  cursor: pointer;
}

/* optional hover effect */
.white-btn.plus:hover { background-color: #218838 !important; }
.white-btn.minus:hover { background-color: #c82333 !important; }

#playerContainer {
  width: 50%;
  height: 100%;
  background: #111;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  box-shadow: inset 0 0 40px rgba(0, 212, 255, 0.3);
}


.playerSection {
  background: rgba(0,0,0,0.5);
  padding: 25px 30px;
  border-radius: 16px;
  margin-bottom: 40px;
  width: 300px;
  text-align: center;
  box-shadow: 0 0 15px #6a0dad, 0 0 25px #00d4ff;
}

.playerSection h2 {
  color: #FFD700;
  margin-bottom: 20px;
  text-shadow: 0 0 8px black;
}

/* Buttons */
.playerBtn {
  background: linear-gradient(135deg, #6a0dad, #00d4ff);
  color: white;
  border: none;
  padding: 12px 30px;
  margin: 8px;
  font-size: 18px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 0 0 12px #00d4ff, 0 0 16px #6a0dad;
  transition: 0.2s ease;
}

.playerBtn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px #00d4ff, 0 0 30px #6a0dad;
}

.playerBtn:active {
  transform: scale(0.97);
}

</style>
</head>
<body>

<!-- Left: Monopoly Board -->
<div id="boardWrapper">
  <div id="board">
    <img id="boardImg" src="map2.jpg" alt="Monopoly Board">
    <div id="p1" class="piece red">p1</div>
    <div id="p2" class="piece blue">p2</div>
    <div id="p3" class="piece yellow">p3</div>
    <div id="p4" class="piece green">p4</div>

    <div id="centralDisplayContainer">
      <div id="moneyContainer">
        <div id="money-p1-overlay" class="moneyBox red">Player1: $0</div>
        <div id="money-p2-overlay" class="moneyBox blue">Player2: $0</div>
        <div id="money-p3-overlay" class="moneyBox yellow">Player3: $0</div>
        <div id="money-p4-overlay" class="moneyBox green">Player4: $0</div>
      </div>
      <div id="displayContainer">
        <div id="display1" class="displayBox">Display 1</div>
        <div id="display2" class="displayBox">Display 2</div>
      </div>
    </div>

    <div id="propertyLink">
      <a href="https://raw.githubusercontent.com/nightywolfy/monopoly/main/properties.jpg" target="_blank">
        <img src="https://raw.githubusercontent.com/nightywolfy/monopoly/main/properties.jpg">
      </a>
    </div>
    <div id="rulesLink">
      <a href="https://raw.githubusercontent.com/nightywolfy/monopoly/main/rules.jpg" target="_blank">
        <img src="https://raw.githubusercontent.com/nightywolfy/monopoly/main/rules.jpg">
      </a>
    </div>
  </div>
</div>

<!-- Right side: Player selection -->
<div id="playerContainer">

  <div class="playerSection">
    <h2>2-Player Game</h2>
    <button class="playerBtn" onclick="choosePlayer('player1','2p')">Player 1</button>
    <button class="playerBtn" onclick="choosePlayer('player2','2p')">Player 2</button>
  </div>

 <div class="playerSection">
  <h2>3-4 Player Game</h2>
  <button class="playerBtn" onclick="choosePlayer('p1','4p')">Player 1</button>
  <button class="playerBtn" onclick="choosePlayer('p2','4p')">Player 2</button>
  <button class="playerBtn" onclick="choosePlayer('p3','4p')">Player 3</button>
  <button class="playerBtn" onclick="choosePlayer('p4','4p')">Player 4</button>
</div>

</div>


<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const colorMap = {red:"p1", blue:"p2", yellow:"p3", green:"p4"};
const buildingPositions = {
  1: { x: 740, y: 795 },
  3: { x: 595, y: 795 },
  6: { x: 373, y: 795 },
  8: { x: 232, y: 795 },
  9: { x: 160, y: 795 },
  11: { x: 105, y: 735 },
  12: { x: 105, y: 665 },
  14: { x: 105, y: 515 },
  16: { x: 105, y: 375 },
  17: { x: 105, y: 300 },
  19: { x: 105, y: 155 },
  21: { x: 156, y: 104 },
  22: { x: 230, y: 104 },
  24: { x: 375, y: 104 },
  26: { x: 520, y: 104 },
  28: { x: 665, y: 104 },
  29: { x: 740, y: 104 },
  31: { x: 793, y: 155 },
  33: { x: 793, y: 300 },
  34: { x: 793, y: 370 },
  37: { x: 793, y: 590 },
  39: { x: 793, y: 734 },
  0: { x: 595, y: 681 },
  4: { x: 525, y: 681 },
  5: { x: 679, y: 590 },
  10: { x: 305, y: 681 },
  13: { x: 218, y: 590 },
  15: { x: 380, y: 681 },
  20: { x: 218, y: 305 },
  25: { x: 218, y: 375 },
  27: { x: 304, y: 220 },
  30: { x: 595, y: 220 },
  35: { x: 679, y: 303 },
  38: { x: 523, y: 220 }
};

function updatePieces(data){
    if(!data || typeof data !== 'object'){
        console.warn("Pieces data invalid:", data);
        return;
    }

    // Map positions to arrays of colors (to detect overlaps)
    const posMap = {};

    for(const [color, pos] of Object.entries(data)){
        if(!pos || typeof pos.x !== "number" || typeof pos.y !== "number"){
            console.warn("Invalid position for", color, pos);
            continue;
        }

        const key = `${pos.x},${pos.y}`;
        if(!posMap[key]) posMap[key] = [];
        posMap[key].push(color);
    }

    for(const [key, colors] of Object.entries(posMap)){
        const [baseX, baseY] = key.split(',').map(Number);

        colors.forEach((color, idx) => {
            const id = colorMap[color];
            if(!id) return;
            const el = document.getElementById(id);
            if(!el) return;

            // Slight offsets for overlapping pieces
            let offsetX = 0, offsetY = 0;
            if(idx === 1){ offsetX = 10; offsetY = 0; }  // second player
            if(idx === 2){ offsetX = 0; offsetY = 10; }  // third player
            if(idx === 3){ offsetX = 10; offsetY = 10; } // fourth player

            el.style.left = (baseX + offsetX) + 'px';
            el.style.top  = (baseY + offsetY) + 'px';
            el.style.zIndex = 20;
        });
    }
}




// Displays
function updateDisplay1(text){ document.getElementById('display1').innerText = text || ''; }
function updateDisplay2(text){ document.getElementById('display2').innerText = text || ''; }

function updateMoney(data){
  document.getElementById('money-p1-overlay').textContent = 'Player1: $' + data.p1;
  document.getElementById('money-p2-overlay').textContent = 'Player2: $' + data.p2;
  document.getElementById('money-p3-overlay').textContent = 'Player3: $' + data.p3;
  document.getElementById('money-p4-overlay').textContent = 'Player4: $' + data.p4;
}

function renderElements(type, data, imgSrc){
    const board = document.getElementById('board');
    if(!board){ console.error("Board container missing"); return; }

    // Remove existing elements
    document.querySelectorAll(`.${type}`).forEach(el => el.remove());

    if(!data || typeof data !== 'object'){
        console.warn(type + " data invalid:", data);
        return;
    }

    for(const [space, count] of Object.entries(data)){
        if(!count) continue;
        const pos = buildingPositions[space];
        if(!pos){ console.warn("No position for space:", space); continue; }

        // Stack houses horizontally, hotels centered
        for(let i=0;i<count;i++){
            const el = document.createElement('img');
            el.src = imgSrc;
            el.className = type;
            el.style.position = 'absolute';
            el.style.zIndex = 25;

            // Offset each house horizontally
            if(type === 'house'){
                el.style.left = (pos.x - 14 + i*10) + 'px'; // 10px spacing between houses
                el.style.top  = (pos.y - 14) + 'px';
            } else if(type === 'hotel'){
                // hotel always centered, slightly higher if multiple hotels (rare)
                el.style.left = (pos.x - 14) + 'px';
                el.style.top  = (pos.y - 14 - i*2) + 'px';
            }

            el.style.width = '29px';
            el.style.height = '29px';
            board.appendChild(el);

            // Fallback if image fails to load
            el.onerror = () => {
                console.warn("Failed to load image:", imgSrc);
                el.src = 'https://via.placeholder.com/29?text=?';
            }
        }
    }
}

// Initial fetch
fetch('/pieces.json').then(res=>res.json()).then(updatePieces);
fetch('/display1.json').then(res=>res.json()).then(data=>updateDisplay1(data.text));
fetch('/display2.json').then(res=>res.json()).then(data=>updateDisplay2(data.text));
fetch('/money.json').then(res=>res.json()).then(updateMoney);
fetch('/hotels.json').then(res=>res.json()).then(data=>renderElements('hotel',data,'https://raw.githubusercontent.com/nightywolfy/monopoly/main/hotel.webp'));
fetch('/houses.json').then(res=>res.json()).then(data=>renderElements('house',data,'https://raw.githubusercontent.com/nightywolfy/monopoly/main/house.webp'));

// Socket.IO updates
socket.on('piecesUpdate',updatePieces);
socket.on('displayUpdate1', data => updateDisplay1(data.text));
socket.on('displayUpdate2', data => updateDisplay2(data.text));
socket.on('moneyUpdate',updateMoney);
socket.on('hotelsUpdate',data=>renderElements('hotel',data,'https://raw.githubusercontent.com/nightywolfy/monopoly/main/hotel.webp'));
socket.on('housesUpdate',data=>renderElements('house',data,'https://raw.githubusercontent.com/nightywolfy/monopoly/main/house.webp'));

async function choosePlayer(player, gameMode){
  const res = await fetch(`/getKey?player=${player}&game=${gameMode}`);
  const data = await res.json();
  if(data.ok){
    window.location.href = `/player?name=${player}&auth=${data.key}`;
  } else {
    alert('Error getting access key');
  }
}

</script>
</body>
</html>
